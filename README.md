<p align="center">
  <a href="https://github.com/Hathoute/workflow-preprocessor/actions"><img alt="ci status" src="https://github.com/Hathoute/workflow-preprocessor/actions/workflows/main.yml/badge.svg"></a>
  <a href="https://codecov.io/github/Hathoute/workflow-preprocessor"><img alt="codecov" src="https://codecov.io/github/Hathoute/workflow-preprocessor/branch/main/graph/badge.svg?token=80E2ZCG9JL"></a>
  <a href="https://opensource.org/licenses/MIT"><img alt="license mit" src="https://img.shields.io/badge/License-MIT-yellow.svg"></a>
</p>

# GitHub Workflow Processor

A GitHub Action that generates GitHub workflows from templates.

Supports importing and extending other templates, as well as using YAML anchors.

## Usage

```yaml
name: Generate Workflows
on:
  push:
    branches:
      - main
jobs:
  generate:
    - uses: actions/checkout@v3
    - uses: Hathoute/workflow-preprocessor@v1
      with:
        generated-directory: 'generated'
    - uses: actions/upload-artifact@v3
      with:
        name: generated-workflows
        path: generated
  ```

## Inputs

| Input               | Required | Description                                                                             | Default           |
|---------------------|----------|-----------------------------------------------------------------------------------------|-------------------|
| templates-directory | false    | The directory containing the templates to use, will not scan subdirectories             | './src/templates' |
| workflows-directory | false    | The directory containing the workflows to use, will not scan subdirectories             | './src'           |
| schema-directory    | false    | The directory containing the schemas, you can use this to override the default schemas  | './schema'        |
| generated-directory | false    | The directory to output the generated workflows to                                      | './generated'     |
| log-level           | false    | The log level to use, can be [trace, debug, info, warn, error]                          | 'info'            |
| die-when-invalid    | false    | Whether to die when the generated workflow is invalid, per the definition of the schema | 'true'            |

## Workflows and Templates

There are two main components to this action, workflows and templates.

A <b>workflow</b> is a YAML file that resembles to the structure of a GitHub workflow, but with some extra features.
These are the files that will be generated by this action in the `generated-directory`.
An example workflow would be:
```yaml
name: My Workflow
on:
  push:
    branches:
      - main
imports: 
  - 'templates/build.yml'
jobs:
  build:
    runs-on: ubuntu-latest
    extends: build/maven-java
```

A <b>template</b> is a YAML file that contains different job templates that can be used in workflows.
These files are NOT generated, and are only used to be referenced by workflows. 
An example template would be:
```yaml
internals:
  - setup: &checkout !zipped
      - uses: actions/checkout@v2
      - name: Set up JDK 17
        uses: actions/setup-java@v1
        with:
          java-version: 17
jobs:
  maven-java:
    runs-on: ubuntu-latest
    steps: !unzip
      - *checkout
      - name: Build with Maven
        run: mvn -B package --file pom.xml
  gradle-java:
    runs-on: ubuntu-latest
    steps: !unzip
      - *checkout
      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
      - name: Build with Gradle
        run: ./gradlew build
```

## Custom YAML Tags

The `!zipped` tag allows you to mark an array that can be flattened using the `!unzip` tag.

This is extremely useful when you want to use YAML anchors to define a set of steps, and then use 
them at the start of a job.

Example usage:
```yaml
pre-steps: &pre_steps !zipped
  - name: step1
    run: echo step1
  - name: step2
    run: echo step2

job:
  steps: !unzip
    - *pre_steps
    - name: step3
      run: echo step3
  ```

Would result in:
```yaml
job:
  steps:
    - name: step1
      run: echo step1
    - name: step2
      run: echo step2
    - name: step3
      run: echo step3
  ```

## License
[![FOSSA Status](https://app.fossa.com/api/projects/git%2Bgithub.com%2FHathoute%2Fworkflow-preprocessor.svg?type=large)](https://app.fossa.com/projects/git%2Bgithub.com%2FHathoute%2Fworkflow-preprocessor?ref=badge_large)